# 1 Java高并发商城秒杀优化导学

## 1.1课程技术点

![image-20201119154516406](C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119154516406.png)

前端用到的知识点很简单，异步下单的实现是用的RabbitMQ消息队列，用到了redis缓存，要知道它和memcash的异同点，redis再服务器重启之后保持数据不丢，相当于一个内存数据库，这里主要是因为redis可以做持久化，memcash不可以持久化，Druid事阿里巴巴开源出来的一个连接池，可以监控数据库中的链接

最大连接是多少，最大并发是多少。整个框架是基于springboot开发的，微服务实现的最好方式就是springboot，一般现在开发新的项目都是用到微服务的，访问数据库用到了mYBATIS，JSR303是一个服务端的验证框架，用来做服务端的一个参数校验

## 1.2 秒杀业务介绍

![image-20201119155438144](C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119155438144.png)

最开始我们搭建环境，搭建完成以后把mYBATIS，redis集成进来，然后在这个基础上做一个**分布式session**,应用最后肯定是分布式部署的，只有秒杀没有什么优惠活动什么的还是很简单的，无非是用户浏览我们的商品列表，跳转到我们的商品详情，在商品详情页点击我们的秒杀按钮，如果秒杀成功，就生成一个订单，可以去详情页查看订单。这个项目中对后台的管理做的很模糊，增删改查没什么意思，这门课里面没有讲，对大家而言就是浪费时间。整个业务逻辑实现以后，我们就对系统进行压测，就可以发现系统存在各种各样的问题。原来单线程单用户，或者并发量比较小的时候，业务流程都是正确的没有问题，并发量大的时候问题就出现了。压测的时候给你演示一下，后面就去做缓存方面的优化，从最开始，用户的手机端做了前后端分离以后，把静态页面直接缓存到用户的浏览器端，或者手机端，然后用户访问到我们网站的缓存或者说是镜像，然后再才是网关，我们这里用的是nginx,在nginx我们也是可以加缓存的，通过nginx在往后就是我们的应用服务器了，这里也可以做页面级的缓存，例如把整个页面加到我们的redis里面去，更进一步的，还有url级别的缓存，更进一步的，对象级的缓存。缓存的应用在大并发中用的很广，但是加了缓存会导致数据的不一致，怎么做一个平衡，到底是先写缓存，再数据库，还是先写数据库，再写缓存。

后面就是用消息队列做异步下单，请求全部一下子到DB的话，DB是扛不住这么大的压力的，所以引入了RabbitMQ消息队列，后面还讲如何用nginx对我们的应用做一个横向的扩展，大并发的瓶颈在于数据库，数据库压力小了以后就可以做这种扩展，光往上面堆服务器是不行的，请求到了DB，还是直接透穿了DB

最终程序运行在网站上，为了保证用户体验，做了一些防刷限流，验证码相关的东西，还会隐藏接口地址，保证安全

## 1.3 能学到什么？

应对大并发，主要是两个思路;

- 如何应用缓存
- 如何应用异步

做好这两个以后，后面的分布式，负载均衡都是水到渠成了

# 2 课程内容

## 2.1项目环境搭建

![image-20201119162251392](C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119162251392.png)

传统的springMVC使用JSP作为页面模板，在这里我们使用Themeleaf作为页面模板，然后呢，我们的接口呢，用一个类，叫result类，对json输出做一个封装

然后带着大家一起集成MyBatis,Redis,带着大家写一个通用缓存key的封装，访问缓存得到时候，一般用一个key来获取一个value，但是你只用STRING来作为key，那肯定是不利于维护的，所以我们带着大家写一个比较好的封装

## 2.2 实现登录功能

![image-20201119163415138](C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119163415138.png)

对用户的信息设计一个数据库存储，再对用户输入的密码做两次MD5存到数据库里面，主要是为了安全方面的考虑所以我们做两次MD5，然后我们搞一个JSR303参数校验，我们自己写一个校验器出来，现在的互联网应用很少会用到容器提供的原生的session，因为我们的应用都是分布式来部署的，所以实现一个分布式的session是很重要的

## 2.3 实现秒杀功能

![image-20201119163615445](C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119163615445.png)

用户浏览你商品的列表页，点击某一个商品会跳转到商品的详情页，在详情页点击秒杀按钮，如果秒杀成功，进入到订单的详情页

## 2.4 JMeter压测

![image-20201119163826823](C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119163826823.png)

既然是压测，肯定不止一个用户来使用对吧，那就自定义变量去模拟一下多个用户，然后再教一下，在Linux命令行下面怎么使用这个压测工具。最后，我们的spring boot应用并不是以main函数和jar包的方式运行的，而是打成一个war包放到我们的Tomcat下来使用的

## 2.5 页面优化技术

![image-20201119164408297](C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119164408297.png)

并发主要的瓶颈就在于数据库，所以我们优化的主要方向就是减少对数据库的访问，最有效的手段就是加缓存，页面静态化和前后端分离就是说页面一般也是通过调用服务端的接口来完成页面功能，静态资源的优化就是指CSS，JS怎么优化。最后CDN优化，放到课程后面讲

## 2.6 秒杀接口优化

![image-20201119164518061](C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119164518061.png)

![image-20201119164645114](C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119164645114.png)

!(C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119164613559.png)

这些都后面具体来讲，你只需要接口优化的功能是通过这些技术实现的就好了

## 2.7 安全优化

![image-20201119164919201](C:\Users\57551\AppData\Roaming\Typora\typora-user-images\image-20201119164919201.png)

秒杀接口地址隐藏的意思是，在真正的秒杀开始前，你是拿不到我的秒杀地址的哦

再做个数学公式的验证码，比如1+1=？，这个验证码非常有用，不光挡住了机器人，人在做题的时候拉长了访问时间，达到了削峰的目的

最后是接口防刷，这是个什么意思呢，就是我们会做一个这种限制，比如一分钟之内，一个用户最多访问我们的系统10次，类似于限流的一个手段，这也是非常通用的一个手段，不单单是针对秒杀这一个业务场景。

